/*
  ==============================================================================

    SubtractiveSynth.h
    Created: 24 Apr 2022 8:38:49pm
    Author:  St

  ==============================================================================
*/

#pragma once

#include "DDSPCommon.h"

#include "codegen/ColoredNoise.h"
#include "codegen/fft.h"


namespace DDSP
{
	//________________________________________________________________________________
	class SubtractiveSynth
	{
	public:
		static constexpr Magnitudes dv
		{ 0.0, 0.0024076366639015356,
			0.0096073597983847847, 0.021529832133895588, 0.038060233744356631,
			0.059039367825822475, 0.084265193848727382, 0.1134947733186315,
			0.14644660940672621, 0.18280335791817726, 0.22221488349019886,
			0.2643016315870011, 0.30865828381745508, 0.35485766137276886,
			0.40245483899193585, 0.45099142983521961, 0.49999999999999994,
			0.54900857016478033, 0.5975451610080641, 0.645142338627231,
			0.69134171618254481, 0.73569836841299885, 0.777785116509801,
			0.81719664208182263, 0.85355339059327373, 0.88650522668136844,
			0.91573480615127267, 0.94096063217417747, 0.96193976625564337,
			0.97847016786610441, 0.99039264020161522, 0.99759236333609835, 1.0,
			0.99759236333609835, 0.99039264020161522, 0.97847016786610441,
			0.96193976625564337, 0.94096063217417747, 0.91573480615127267,
			0.88650522668136844, 0.85355339059327373, 0.81719664208182263,
			0.777785116509801, 0.73569836841299885, 0.69134171618254481,
			0.645142338627231, 0.5975451610080641, 0.54900857016478033,
			0.49999999999999994, 0.45099142983521961, 0.40245483899193585,
			0.35485766137276886, 0.30865828381745508, 0.2643016315870011,
			0.22221488349019886, 0.18280335791817726, 0.14644660940672621,
			0.1134947733186315, 0.084265193848727382, 0.059039367825822475,
			0.038060233744356631, 0.021529832133895588, 0.0096073597983847847,
			0.0024076366639015356, 0.0 };

		SubtractiveSynth();

		void process( double n_samples, const Magnitudes& magnitudes, double initial_bias, Amplitudes& out );

		double colour{};

	private:
		void eml_rand_mt19937ar_stateful_init();
		void fftshift( Magnitudes& );

		coder::dsp::ColouredNoiseA white_n;
		coder::dsp::ColouredNoiseB brown_n;
		coder::dsp::ColouredNoiseC violet_n;

		creal_T dcv[ maxMagnitudes ];
		creal_T dcv1[ maxMagnitudes ];

		Amplitudes brown_noise{};
		Amplitudes violet_noise{};
		Amplitudes white_noise{};

		Magnitudes x{};
		Magnitudes z1{};

		std::array< unsigned, stateSize > state{};
	};
}